/**
 * Routes generator - Auto-generates REST route definitions from entities
 *
 * @module cli/generators/mock/routes
 * @category CLI
 */

import type { AnalyzedSchema } from '../../types';
import { CodeBuilder } from '../../utils/code-builder';
import { pluralize } from '../../utils/pluralize';

/**
 * Generate routes.ts file with REST route definitions
 *
 * @param schemas - Analyzed schemas
 * @returns Generated TypeScript code
 */
export function generateRoutes(schemas: AnalyzedSchema[]): string {
  const code = new CodeBuilder();

  code.comment('GENERATED BY SCHEMOCK - DO NOT EDIT');
  code.line();

  code.comment('Auto-generated REST route definitions');
  code.comment('');
  code.comment('These routes are used by:');
  code.comment('- MSW handlers for intercepting requests');
  code.comment('- Backend reference for implementing custom servers');
  code.line();

  // Generate route types
  code.comment('Route definition type');
  code.block('export interface RouteDefinition {', () => {
    code.line("method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';");
    code.line('path: string;');
  }, '}');
  code.line();

  // Generate entity routes
  code.comment('Entity route definitions');
  code.block('export const routes = {', () => {
    for (const schema of schemas) {
      if (schema.isJunctionTable) continue;
      generateEntityRoutes(code, schema);
    }
  }, '} as const;');
  code.line();

  // Generate type export
  code.line('export type Routes = typeof routes;');
  code.line();

  // Generate route path helpers
  generateRouteHelpers(code, schemas);

  return code.toString();
}

/**
 * Generate routes for a single entity
 */
function generateEntityRoutes(code: CodeBuilder, schema: AnalyzedSchema): void {
  const { name } = schema;
  const pluralName = pluralize(name);
  const basePath = `/api/${pluralName}`;

  code.block(`${pluralName}: {`, () => {
    code.line(`list:   { method: 'GET',    path: '${basePath}' },`);
    code.line(`get:    { method: 'GET',    path: '${basePath}/:id' },`);
    code.line(`create: { method: 'POST',   path: '${basePath}' },`);
    code.line(`update: { method: 'PUT',    path: '${basePath}/:id' },`);
    code.line(`patch:  { method: 'PATCH',  path: '${basePath}/:id' },`);
    code.line(`delete: { method: 'DELETE', path: '${basePath}/:id' },`);
  }, '},');
}

/**
 * Generate route path helper functions
 */
function generateRouteHelpers(code: CodeBuilder, schemas: AnalyzedSchema[]): void {
  code.comment('Route path helpers - generate paths with parameters');
  code.line();

  for (const schema of schemas) {
    if (schema.isJunctionTable) continue;

    const { name, pascalName } = schema;
    const pluralName = pluralize(name);
    const basePath = `/api/${pluralName}`;

    code.block(`export const ${name}Routes = {`, () => {
      code.line(`list: () => '${basePath}',`);
      code.line(`get: (id: string) => \`${basePath}/\${id}\`,`);
      code.line(`create: () => '${basePath}',`);
      code.line(`update: (id: string) => \`${basePath}/\${id}\`,`);
      code.line(`patch: (id: string) => \`${basePath}/\${id}\`,`);
      code.line(`delete: (id: string) => \`${basePath}/\${id}\`,`);
    }, '};');
    code.line();
  }
}
