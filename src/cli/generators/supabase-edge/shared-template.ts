/**
 * Supabase Edge Shared Templates
 *
 * Generates shared utility files for Supabase Edge Functions.
 *
 * @module cli/generators/supabase-edge/shared-template
 * @category CLI
 */

import type { GenerationTarget, SchemockConfig } from '../../types';

/**
 * Generate the CORS headers utility
 */
export function generateSharedCors(): string {
  return `// GENERATED BY SCHEMOCK - DO NOT EDIT
// Shared CORS headers for Edge Functions

/**
 * Default CORS headers for Edge Functions
 * Customize as needed for your application
 */
export function corsHeaders(origin: string = '*'): HeadersInit {
  return {
    'Access-Control-Allow-Origin': origin,
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Client-Info, apikey',
    'Access-Control-Max-Age': '86400',
  };
}

/**
 * Create a CORS preflight response
 */
export function corsPreflightResponse(origin: string = '*'): Response {
  return new Response('ok', { headers: corsHeaders(origin) });
}
`;
}

/**
 * Generate the Supabase client utility
 */
export function generateSharedSupabaseClient(target: GenerationTarget): string {
  const envPrefix = (target.options?.envPrefix as string) || 'SUPABASE';

  return `// GENERATED BY SCHEMOCK - DO NOT EDIT
// Shared Supabase client for Edge Functions

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabaseUrl = Deno.env.get('${envPrefix}_URL')!;
const supabaseKey = Deno.env.get('${envPrefix}_SERVICE_ROLE_KEY')!;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing Supabase environment variables: ${envPrefix}_URL or ${envPrefix}_SERVICE_ROLE_KEY');
}

/**
 * Supabase client with service role key
 * Use for server-side operations that bypass RLS
 */
export const supabase = createClient(supabaseUrl, supabaseKey);

/**
 * Create a Supabase client with a user's JWT
 * Use for operations that should respect RLS
 */
export function createUserClient(jwt: string) {
  return createClient(supabaseUrl, supabaseKey, {
    global: {
      headers: {
        Authorization: \`Bearer \${jwt}\`,
      },
    },
  });
}
`;
}

/**
 * Generate the shared types file (wraps the generated types)
 */
export function generateSharedTypes(typesCode: string): string {
  return `// GENERATED BY SCHEMOCK - DO NOT EDIT
// Shared types for Edge Functions

${typesCode}
`;
}

/**
 * Generate the deno.json configuration file
 */
export function generateDenoConfig(config: SchemockConfig): string {
  const denoConfig = {
    imports: {
      '@supabase/supabase-js': 'https://esm.sh/@supabase/supabase-js@2',
    },
    compilerOptions: {
      allowJs: true,
      lib: ['deno.window'],
      strict: true,
    },
  };

  return JSON.stringify(denoConfig, null, 2) + '\n';
}
