/**
 * Neon Router Template
 *
 * Generates the main Express router that combines all entity handlers.
 *
 * @module cli/generators/neon/router-template
 * @category CLI
 */

import type { AnalyzedSchema, GenerationTarget, SchemockConfig } from '../../types';

/**
 * Generate the main router file
 */
export function generateRouterFile(
  schemas: AnalyzedSchema[],
  target: GenerationTarget,
  config: SchemockConfig
): string {
  const apiPrefix = config.apiPrefix || '/api';
  const hasNewMiddlewareConfig = config.middleware !== undefined;

  const lines: string[] = [
    '// GENERATED BY SCHEMOCK - DO NOT EDIT',
    '',
    "import { Router } from 'express';",
  ];

  // Import handlers for each entity
  for (const schema of schemas) {
    if (schema.isJunctionTable) continue;
    lines.push(`import * as ${schema.pluralName}Handlers from './handlers/${schema.pluralName}';`);
  }

  // Import middleware if configured
  if (hasNewMiddlewareConfig) {
    lines.push("import { applyMiddleware } from './middleware/chain';");
  } else if (target.middleware?.auth) {
    lines.push("import { authMiddleware } from './middleware/auth';");
  }

  lines.push('');

  // Export router factory function
  lines.push('/**');
  lines.push(' * Create and configure the API router');
  lines.push(' * @param options - Router configuration options');
  lines.push(' */');
  lines.push('export function createRouter(options: {');
  lines.push('  /** Skip auth for these paths */');
  lines.push('  skipAuth?: string[];');
  lines.push('  /** Custom middleware to apply */');
  lines.push('  middleware?: Array<(req: any, res: any, next: any) => void>;');
  lines.push('} = {}): Router {');
  lines.push('  const router = Router();');
  lines.push('');

  // Apply global middleware
  if (hasNewMiddlewareConfig) {
    lines.push('  // Apply middleware chain from config');
    lines.push('  applyMiddleware(router, options.skipAuth);');
  } else if (target.middleware?.auth) {
    lines.push('  // Apply auth middleware');
    lines.push('  router.use(authMiddleware);');
  }

  lines.push('');
  lines.push('  // Apply custom middleware');
  lines.push('  if (options.middleware) {');
  lines.push('    options.middleware.forEach(mw => router.use(mw));');
  lines.push('  }');
  lines.push('');

  // Register routes for each entity
  for (const schema of schemas) {
    if (schema.isJunctionTable) continue;

    lines.push(`  // ${schema.pascalName} routes`);
    lines.push(`  router.get('${apiPrefix}/${schema.pluralName}', ${schema.pluralName}Handlers.list);`);
    lines.push(`  router.get('${apiPrefix}/${schema.pluralName}/:id', ${schema.pluralName}Handlers.getOne);`);
    lines.push(`  router.post('${apiPrefix}/${schema.pluralName}', ${schema.pluralName}Handlers.create);`);
    lines.push(`  router.put('${apiPrefix}/${schema.pluralName}/:id', ${schema.pluralName}Handlers.update);`);
    lines.push(`  router.delete('${apiPrefix}/${schema.pluralName}/:id', ${schema.pluralName}Handlers.remove);`);
    lines.push('');
  }

  lines.push('  return router;');
  lines.push('}');
  lines.push('');

  // Export default configured router
  lines.push('/**');
  lines.push(' * Pre-configured router instance');
  lines.push(' * Use createRouter() for custom configuration');
  lines.push(' */');
  lines.push('export const router = createRouter();');

  return lines.join('\n');
}
